<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="js/app.js"></script>
</head>
<body>


<script>
    let markers = [];

    // gps-positions (service, period)
    let getGpsPositionsPromise = new Promise(resolve => {
        let gpsPositions = [
            { index: 1 },
            { index: 2 },
            { index: 3 },
            { index: 4 },
            { index: 5 },
        ];

        setTimeout(() => {
            resolve(gpsPositions);
        }, 1000)
    })
    .then(gpsPositions => {
        retrievingAllMarkersPromise = new Promise(resolve => {

            // per ogni gps-position, ritrova lettura
            gpsPositions.forEach((gpsPosition, index) => {

                // simulate axios call to db
                axiosCall = new Promise(resolve => {
                    setTimeout(() => {
                        resolve(Math.floor(Math.random() * 100));
                    }, 500)
                });

                // create marker when api call come back
                axiosCall.then(reading => {
                    console.log(`BACK FROM API, reading for gps #${gpsPosition.index} is ${reading}`);
                    markers.push(reading)

                    // resolve promise of retrieving all readings
                    if (index === (gpsPositions.length - 1)) {
                        console.log("Finished retrieving readings");
                        resolve(gpsPositions);
                    }
                });
            })
        })
        .then(data => {
            console.log("Init map with markers", markers);
            // console.log(data);
        })
    })

</script>

</body>
</html>
